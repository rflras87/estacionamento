{% extends "base.html" %}

{% block title %}{{ 'Editar' if cliente else 'Novo' }} Cliente{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    <i class="bi bi-person-{{ 'gear' if cliente else 'plus-fill' }} me-2"></i> 
                    {{ 'Editar Cadastro' if cliente else 'Cadastro de Cliente' }}
                </h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('editar_cliente', id=cliente.id) if cliente else url_for('novo_cliente') }}">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nome" class="form-label fw-bold">
                                <i class="bi bi-person me-1"></i> Nome Completo
                            </label>
                            <input type="text" class="form-control" id="nome" name="nome" value="{{ cliente.nome if cliente else '' }}" placeholder="Ex: Rafael Alves" required autofocus>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="telefone" class="form-label fw-bold">
                                <i class="bi bi-telephone me-1"></i> Telefone
                            </label>
                            <input type="text" class="form-control" id="telefone" name="telefone" value="{{ cliente.telefone if cliente else '' }}" placeholder="(11) 99999-9999" oninput="mascaraTelefone(this)">
                            
                            <div id="whatsappDiv" class="form-check mt-1" style="{{ 'display:block' if cliente and cliente.telefone|length > 14 else 'display:none' }}">
                                <input class="form-check-input" type="checkbox" id="is_whatsapp" name="is_whatsapp" {% if cliente and cliente.is_whatsapp %}checked{% endif %}>
                                <label class="form-check-label text-success fw-bold small" for="is_whatsapp">
                                    <i class="bi bi-whatsapp me-1"></i> É WhatsApp?
                                </label>
                            </div>
                        </div>
                    </div>

                    <h5 class="mt-3 text-secondary border-bottom pb-2">
                        <i class="bi bi-car-front-fill me-1"></i> Veículo
                    </h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="placa" class="form-label fw-bold"><i class="bi bi-card-heading me-1"></i> Placa</label>
                            <input type="text" class="form-control text-uppercase bg-light" id="placa" name="placa" value="{{ cliente.placa if cliente else '' }}" placeholder="AAA1234" maxlength="7" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold"><i class="bi bi-tag-fill me-1"></i> Marca</label>
                            <input type="text" class="form-control" name="marca_veiculo" value="{{ cliente.marca_veiculo if cliente else '' }}" placeholder="Ex: VW">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold"><i class="bi bi-car-front me-1"></i> Modelo</label>
                            <input type="text" class="form-control" name="modelo_veiculo" value="{{ cliente.modelo_veiculo if cliente else '' }}" placeholder="Ex: Fox">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold"><i class="bi bi-palette me-1"></i> Cor</label>
                            <input type="text" class="form-control" name="cor_veiculo" value="{{ cliente.cor_veiculo if cliente else '' }}" placeholder="Ex: Cinza">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Tipo de Veículo</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipo_veiculo" id="veiculoCarro" value="CARRO" {% if not cliente or cliente.tipo_veiculo == 'CARRO' %}checked{% endif %}>
                                    <label class="form-check-label" for="veiculoCarro">
                                        <i class="bi bi-car-front-fill text-primary"></i> Carro
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipo_veiculo" id="veiculoMoto" value="MOTO" {% if cliente and cliente.tipo_veiculo == 'MOTO' %}checked{% endif %}>
                                    <label class="form-check-label" for="veiculoMoto">
                                        <i class="bi bi-bicycle text-primary"></i> Moto
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Características</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="is_suv" id="is_suv" {% if cliente and cliente.is_suv %}checked{% endif %}>
                                    <label class="form-check-label" for="is_suv">
                                        <i class="bi bi-truck-front-fill text-secondary"></i> SUV
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="is_eletrico" id="is_eletrico" {% if cliente and cliente.is_eletrico %}checked{% endif %}>
                                    <label class="form-check-label" for="is_eletrico">
                                        <i class="bi bi-lightning-charge-fill text-warning"></i> Elétrico
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="bi bi-journal-text me-1"></i> Observações</label>
                        <textarea class="form-control" name="observacoes" rows="2" placeholder="Ex: Cliente VIP, chave na portaria...">{{ cliente.observacoes if cliente else '' }}</textarea>
                    </div>
                    
                    <h5 class="mt-4 text-secondary border-bottom pb-2">
                        <i class="bi bi-wallet2 me-1"></i> Plano e Pagamento
                    </h5>
                    
                    <div class="mb-3 mt-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="tipo_cliente" id="tipoAvulso" value="AVULSO" {% if not cliente or cliente.tipo_cliente == 'AVULSO' %}checked{% endif %}>
                            <label class="form-check-label fw-bold" for="tipoAvulso">
                                <i class="bi bi-hourglass-split me-1"></i> Avulso (Paga por uso)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="tipo_cliente" id="tipoMensalista" value="MENSALISTA" {% if cliente and cliente.tipo_cliente == 'MENSALISTA' %}checked{% endif %}>
                            <label class="form-check-label fw-bold" for="tipoMensalista">
                                <i class="bi bi-calendar-check-fill text-primary"></i> Mensalista
                            </label>
                        </div>
                    </div>
                    
                    <div id="regraCicloDiv" class="alert alert-secondary mt-3 border" style="display: none; background-color: #e9ecef;">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold text-dark">
                                <i class="bi bi-list-stars me-1"></i> Selecione o Plano:
                            </label>
                            <select class="form-select" name="plano_mensal">
                                <option value="INTEGRAL" {% if cliente and cliente.plano_mensal == 'INTEGRAL' %}selected{% endif %}>Integral (24h)</option>
                                <option value="DIURNO" {% if cliente and cliente.plano_mensal == 'DIURNO' %}selected{% endif %}>Diurno</option>
                                <option value="NOTURNO" {% if cliente and cliente.plano_mensal == 'NOTURNO' %}selected{% endif %}>Noturno</option>
                            </select>
                        </div>
                        
                        {% if not cliente %}
                        <hr class="border-secondary">
                        <h6 class="mb-3 text-primary fw-bold">
                            <i class="bi bi-calendar-event me-2"></i>Início da Cobrança
                        </h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="regra_inicio" id="regraImediato" value="IMEDIATO" checked>
                            <label class="form-check-label text-dark" for="regraImediato">
                                <strong>Início Imediato</strong> - Começa HOJE.
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="regra_inicio" id="regraPrimeiroUso" value="PRIMEIRO_USO">
                            <label class="form-check-label text-dark" for="regraPrimeiroUso">
                                <strong>No Primeiro Uso</strong> - Começa na 1ª entrada.
                            </label>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid mt-4 gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save-fill me-2"></i> {{ 'Salvar Alterações' if cliente else 'Salvar Cliente' }}
                        </button>
                        <a href="{{ url_for('listar_clientes') }}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle me-2"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // MÁSCARA DE TELEFONE
    function mascaraTelefone(input) {
        let v = input.value.replace(/\D/g, "");
        const whatsappDiv = document.getElementById('whatsappDiv');
        if (v.length >= 3 && v.charAt(2) === '9') {
            whatsappDiv.style.display = 'block';
            v = v.replace(/^(\d\d)(\d)/g, "($1) $2"); 
            v = v.replace(/(\d{5})(\d)/, "$1-$2");
        } else {
            if (v.length < 3 || v.charAt(2) !== '9') {
                whatsappDiv.style.display = 'none';
                document.getElementById('is_whatsapp').checked = false;
            }
            v = v.replace(/^(\d\d)(\d)/g, "($1) $2");
            v = v.replace(/(\d{4})(\d)/, "$1-$2");
        }
        input.value = v.substring(0, 15);
    }

    // TOGGLE MENSALISTA
    document.addEventListener('DOMContentLoaded', function() {
        const tipoMensalista = document.getElementById('tipoMensalista');
        const tipoAvulso = document.getElementById('tipoAvulso');
        const regraCicloDiv = document.getElementById('regraCicloDiv');

        function toggleRegraCiclo() {
            if (tipoMensalista.checked) {
                regraCicloDiv.style.display = 'block';
            } else {
                regraCicloDiv.style.display = 'none';
            }
        }

        tipoMensalista.addEventListener('change', toggleRegraCiclo);
        tipoAvulso.addEventListener('change', toggleRegraCiclo);
        toggleRegraCiclo();
    });
</script>
{% endblock %}
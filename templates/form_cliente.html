{% extends "base.html" %}

{% block title %}{{ 'Editar' if cliente else 'Novo' }} Cliente{% endblock %}

{% block content %}
<style>
    /* CORREÇÃO DE LAYOUT */
    #cpf_cnpj { min-width: 100px; }
    
    /* ESTILO DOS CARDS DE VEÍCULOS */
    .veiculo-card {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
        transition: all 0.3s ease;
    }
    .veiculo-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-color: #ced4da;
    }
    .btn-remove-veiculo {
        position: absolute;
        top: 10px; right: 10px;
        z-index: 10;
    }
    
    /* Ícones nos labels */
    .form-label i {
        color: #6c757d;
        margin-right: 4px;
    }
</style>

<div class="row justify-content-center">
    <div class="col-md-9">
        <div class="card shadow border-0">
            <div class="card-header bg-primary text-white py-3">
                <h3 class="mb-0 fs-4 fw-bold">
                    <i class="bi bi-person-{{ 'gear' if cliente else 'plus-fill' }} me-2"></i> 
                    {{ 'Editar Cadastro' if cliente else 'Novo Cliente' }}
                </h3>
            </div>
            <div class="card-body p-4">
                
                <form method="POST" action="{{ url_for('editar_cliente', id=cliente.id) if cliente and cliente.id else url_for('novo_cliente') }}">
                    
                    <h5 class="text-primary border-bottom pb-2 mb-4">
                        <i class="bi bi-person-vcard-fill me-2"></i> Dados de Contato
                    </h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="nome" class="form-label fw-bold">
                                <i class="bi bi-person-fill"></i> Nome Completo <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control form-control-lg" id="nome" name="nome" value="{{ cliente.nome if cliente else '' }}" placeholder="Ex: Rafael Alves" required autofocus>
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label fw-bold">
                                <i class="bi bi-envelope-at-fill"></i> E-mail
                            </label>
                            <input type="email" class="form-control form-control-lg" id="email" name="email" 
                                value="{{ cliente.email if cliente and cliente.email else '' }}" 
                                placeholder="contato@cliente.com">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="telefone" class="form-label fw-bold">
                                <i class="bi bi-telephone-fill"></i> Telefone Principal
                            </label>
                            <input type="text" class="form-control" id="telefone" name="telefone" value="{{ cliente.telefone if cliente else '' }}" placeholder="(11) 99999-9999" oninput="mascaraTelefone(this)">
                            
                            <div id="whatsappDiv" class="form-check mt-1 ms-1" style="{{ 'display:block' if cliente and cliente.telefone|length > 14 else 'display:none' }}">
                                <input class="form-check-input" type="checkbox" id="is_whatsapp" name="is_whatsapp" {% if cliente and cliente.is_whatsapp %}checked{% endif %}>
                                <label class="form-check-label text-success fw-bold small" for="is_whatsapp">
                                    <i class="bi bi-whatsapp me-1"></i> É WhatsApp?
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="telefone2" class="form-label fw-bold text-muted">
                                <i class="bi bi-telephone"></i> Telefone Secundário
                            </label>
                            <input type="text" class="form-control bg-light" id="telefone2" name="telefone2" 
                                   value="{{ cliente.telefone2 if cliente and cliente.telefone2 is defined else '' }}" 
                                   placeholder="(11) 99999-9999" oninput="mascaraTelefone(this)">
                        </div>
                    </div>

                    <h5 class="mt-4 text-secondary border-bottom pb-2 mb-3">
                        <i class="bi bi-file-earmark-text-fill me-2"></i> Documentação
                    </h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-card-heading"></i> Tipo de Documento
                            </label>
                            <div class="d-flex gap-3 mb-2" id="docTypeSelector">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="doc_type" id="type_cpf" value="cpf" 
                                        {% if not cliente or not cliente.cpf_cnpj or cliente.cpf_cnpj|length <= 14 %}checked{% endif %} 
                                        onclick="resetDocField()">
                                    <label class="form-check-label" for="type_cpf">CPF</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="doc_type" id="type_cnpj" value="cnpj" 
                                        {% if cliente and cliente.cpf_cnpj and cliente.cpf_cnpj|length > 14 %}checked{% endif %} 
                                        onclick="resetDocField()">
                                    <label class="form-check-label" for="type_cnpj">CNPJ</label>
                                </div>
                            </div>
                            
                            <input type="text" class="form-control" id="cpf_cnpj" name="cpf_cnpj" 
                                value="{{ cliente.cpf_cnpj if cliente and cliente.cpf_cnpj else '' }}" 
                                placeholder="Digite apenas números"
                                oninput="mascaraDocumento(this)"
                                onblur="validarDoc(this)">
                            <div id="docFeedback" class="mt-1 small fw-bold"></div>
                        </div>
                    </div>

                    <h5 class="mt-4 text-secondary border-bottom pb-2 mb-3">
                        <i class="bi bi-geo-alt-fill me-2"></i> Endereço
                    </h5>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="cep" class="form-label fw-bold">
                                <i class="bi bi-mailbox2"></i> CEP
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="cep" name="cep" 
                                    value="{{ cliente.cep if cliente and cliente.cep else '' }}" onblur="consultaCEP()" placeholder="00000-000">
                                <button class="btn btn-outline-secondary" type="button" onclick="consultaCEP()"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-7 mb-3">
                            <label for="logradouro" class="form-label fw-bold">
                                <i class="bi bi-signpost-fill"></i> Logradouro
                            </label>
                            <input type="text" class="form-control bg-light" id="logradouro" name="logradouro" 
                                value="{{ cliente.logradouro if cliente and cliente.logradouro else '' }}" readonly>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="numero" class="form-label fw-bold">
                                <i class="bi bi-123"></i> Nº
                            </label>
                            <input type="text" class="form-control" id="numero" name="numero" 
                                value="{{ cliente.numero if cliente and cliente.numero else '' }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5">
                            <label for="bairro" class="form-label fw-bold">
                                <i class="bi bi-map-fill"></i> Bairro
                            </label>
                            <input type="text" class="form-control bg-light" id="bairro" name="bairro" 
                                value="{{ cliente.bairro if cliente and cliente.bairro else '' }}" readonly>
                        </div>
                        <div class="col-md-5">
                            <label for="cidade" class="form-label fw-bold">
                                <i class="bi bi-buildings-fill"></i> Cidade
                            </label>
                            <input type="text" class="form-control bg-light" id="cidade" name="cidade" 
                                value="{{ cliente.cidade if cliente and cliente.cidade else '' }}" readonly>
                        </div>
                        <div class="col-md-2">
                            <label for="estado" class="form-label fw-bold">
                                <i class="bi bi-flag-fill"></i> UF
                            </label>
                            <input type="text" class="form-control bg-light" id="estado" name="estado" maxlength="2"
                                value="{{ cliente.estado if cliente and cliente.estado else '' }}" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                         <label for="complemento" class="form-label fw-bold">
                            <i class="bi bi-building"></i> Complemento
                         </label>
                         <input type="text" class="form-control" id="complemento" name="complemento" 
                                value="{{ cliente.complemento if cliente and cliente.complemento else '' }}" placeholder="Ex: Apto 101, Bloco B">
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-5 border-bottom pb-2 mb-3">
                        <h5 class="text-secondary mb-0">
                            <i class="bi bi-car-front-fill me-2"></i> Veículos
                        </h5>
                        <button type="button" class="btn btn-sm btn-success fw-bold shadow-sm" onclick="adicionarVeiculo()">
                            <i class="bi bi-plus-circle me-1"></i> Adicionar
                        </button>
                    </div>
                    
                    <div id="container-veiculos">
                        <div class="veiculo-card shadow-sm" id="veiculo-0">
                            <h6 class="text-primary fw-bold mb-3"><i class="bi bi-star-fill me-1"></i> Veículo Principal</h6>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-postcard-fill"></i> Placa <span class="text-danger">*</span>
                                    </label>
                                    
                                    <input type="text" class="form-control text-uppercase fw-bold {{ 'bg-secondary text-white' if cliente else 'bg-warning-subtle' }}" 
                                           name="placa" 
                                           value="{{ cliente.placa if cliente else '' }}" 
                                           placeholder="ABC1D23" 
                                           maxlength="7" 
                                           required 
                                           {{ 'readonly' if cliente else '' }}>
                                    {% if cliente %}<div class="form-text text-muted small">Placa não pode ser alterada.</div>{% endif %}
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold"><i class="bi bi-tag-fill"></i> Marca</label>
                                    <input type="text" class="form-control" name="marca_veiculo" value="{{ cliente.marca_veiculo if cliente else '' }}" placeholder="Ex: Chevrolet">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold"><i class="bi bi-car-front"></i> Modelo</label>
                                    <input type="text" class="form-control" name="modelo_veiculo" value="{{ cliente.modelo_veiculo if cliente else '' }}" placeholder="Ex: Onix">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold"><i class="bi bi-palette-fill"></i> Cor</label>
                                    <input type="text" class="form-control" name="cor_veiculo" value="{{ cliente.cor_veiculo if cliente else '' }}" placeholder="Ex: Prata">
                                </div>
                            </div>

                            <div class="row align-items-end"> 
                                <div class="col-md-6">
                                    <label class="form-label fw-bold"><i class="bi bi-list-ul"></i> Tipo</label>
                                    <select class="form-select" name="tipo_veiculo">
                                        <option value="CARRO" {% if not cliente or cliente.tipo_veiculo == 'CARRO' %}selected{% endif %}>Carro</option>
                                        <option value="MOTO" {% if cliente and cliente.tipo_veiculo == 'MOTO' %}selected{% endif %}>Moto</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold mb-2"><i class="bi bi-sliders"></i> Atributos</label>
                                    <div class="d-flex gap-3 p-2 border rounded bg-white" style="height: 38px; align-items: center;"> 
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="checkbox" name="is_suv" id="is_suv" {% if cliente and cliente.is_suv %}checked{% endif %}>
                                            <label class="form-check-label" for="is_suv">SUV / Grande</label>
                                        </div>
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="checkbox" name="is_eletrico" id="is_eletrico" {% if cliente and cliente.is_eletrico %}checked{% endif %}>
                                            <label class="form-check-label" for="is_eletrico">Elétrico</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4 mt-4">
                        <label class="form-label fw-bold text-muted">
                            <i class="bi bi-chat-text-fill"></i> Observações Internas
                        </label>
                        <textarea class="form-control" name="observacoes" rows="2">{{ cliente.observacoes if cliente else '' }}</textarea>
                    </div>
                    
                    <h5 class="mt-4 text-secondary border-bottom pb-2 mb-3">
                        <i class="bi bi-credit-card-2-front-fill me-2"></i> Plano e Pagamento
                    </h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100 border-primary mb-3" id="cardMensalista">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tipo_cliente" id="tipoMensalista" value="MENSALISTA" {% if cliente and cliente.tipo_cliente == 'MENSALISTA' %}checked{% endif %}>
                                        <label class="form-check-label fw-bold fs-5 text-primary" for="tipoMensalista">
                                            Mensalista
                                        </label>
                                        <p class="text-muted small mb-0">Paga valor fixo mensal.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                             <div class="card h-100 border-success mb-3" id="cardAvulso">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tipo_cliente" id="tipoAvulso" value="AVULSO" {% if not cliente or cliente.tipo_cliente == 'AVULSO' %}checked{% endif %}>
                                        <label class="form-check-label fw-bold fs-5" for="tipoAvulso">
                                            Cliente Avulso
                                        </label>
                                        <p class="text-muted small mb-0">Paga por tempo de uso (hora/minuto).</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="regraCicloDiv" class="card bg-light border-primary mt-3" style="display: none;">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold text-primary">Plano Contratado</label>
                                    <select class="form-select border-primary" name="plano_mensal">
                                        <option value="INTEGRAL" {% if cliente and cliente.plano_mensal == 'INTEGRAL' %}selected{% endif %}>Integral (24h)</option>
                                        <option value="DIURNO" {% if cliente and cliente.plano_mensal == 'DIURNO' %}selected{% endif %}>Diurno</option>
                                        <option value="NOTURNO" {% if cliente and cliente.plano_mensal == 'NOTURNO' %}selected{% endif %}>Noturno</option>
                                    </select>
                                </div>
                                {% if not cliente %}
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold text-primary">Início da Cobrança</label>
                                    <div class="d-flex flex-column gap-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="regra_inicio" id="regraImediato" value="IMEDIATO" checked>
                                            <label class="form-check-label" for="regraImediato">Imediato (Hoje)</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="regra_inicio" id="regraPrimeiroUso" value="PRIMEIRO_USO">
                                            <label class="form-check-label" for="regraPrimeiroUso">No Primeiro Uso</label>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-5 pt-3 border-top">
                        <a href="{{ url_for('listar_clientes') }}" class="btn btn-outline-secondary px-4">
                            <i class="bi bi-arrow-left me-1"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary px-5 fw-bold shadow">
                            <i class="bi bi-check-lg me-2"></i> {{ 'Salvar Alterações' if cliente else 'Cadastrar Cliente' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // === LÓGICA DE MÚLTIPLOS VEÍCULOS ===
    let contadorVeiculos = 0;

    function adicionarVeiculo() {
        contadorVeiculos++;
        const container = document.getElementById('container-veiculos');
        
        const htmlVeiculo = `
        <div class="veiculo-card shadow-sm position-relative mt-3" id="veiculo-${contadorVeiculos}" style="border-left: 4px solid #198754;">
            <button type="button" class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2" onclick="removerVeiculo(${contadorVeiculos})" title="Remover">
                <i class="bi bi-trash"></i>
            </button>
            <h6 class="text-success fw-bold mb-3 ms-2">Veículo Adicional #${contadorVeiculos}</h6>
            
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold"><i class="bi bi-postcard-fill me-1"></i> Placa</label>
                    <input type="text" class="form-control text-uppercase bg-white" name="placa_extra_${contadorVeiculos}" placeholder="AAA1234" maxlength="7">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold"><i class="bi bi-tag-fill me-1"></i> Marca</label>
                    <input type="text" class="form-control" name="marca_extra_${contadorVeiculos}" placeholder="Marca">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold"><i class="bi bi-car-front me-1"></i> Modelo</label>
                    <input type="text" class="form-control" name="modelo_extra_${contadorVeiculos}" placeholder="Modelo">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold"><i class="bi bi-palette-fill me-1"></i> Cor</label>
                    <input type="text" class="form-control" name="cor_extra_${contadorVeiculos}" placeholder="Cor">
                </div>
            </div>
        </div>
        `;
        container.insertAdjacentHTML('beforeend', htmlVeiculo);
    }

    function removerVeiculo(id) {
        document.getElementById(`veiculo-${id}`).remove();
    }

    // MÁSCARAS E VALIDAÇÕES
    function mascaraTelefone(input) {
        let v = input.value.replace(/\D/g, "");
        const whatsappDiv = document.getElementById('whatsappDiv');
        if (v.length >= 3 && v.charAt(2) === '9') {
            whatsappDiv.style.display = 'block';
            v = v.replace(/^(\d\d)(\d)/g, "($1) $2"); 
            v = v.replace(/(\d{5})(\d)/, "$1-$2");
        } else {
            if (v.length < 3 || v.charAt(2) !== '9') {
                whatsappDiv.style.display = 'none';
                document.getElementById('is_whatsapp').checked = false;
            }
            v = v.replace(/^(\d\d)(\d)/g, "($1) $2");
            v = v.replace(/(\d{4})(\d)/, "$1-$2");
        }
        input.value = v.substring(0, 15);
    }
    
    // DOCS
    function mascaraDocumento(input) {
        let v = input.value.replace(/\D/g, "");
        const docType = document.querySelector('input[name="doc_type"]:checked').value;

        if (docType === 'cnpj') {
            if (v.length > 14) v = v.substring(0, 14); 
            v = v.replace(/^(\d{2})(\d)/, "$1.$2").replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3").replace(/\.(\d{3})(\d)/, ".$1/$2").replace(/(\d{4})(\d)/, "$1-$2");
        } else {
            if (v.length > 11) v = v.substring(0, 11); 
            v = v.replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        }
        input.value = v;
    }

    function validarDoc(input) {
        const feedback = document.getElementById('docFeedback');
        const v = input.value.replace(/\D/g, "");
        if(v.length > 0 && (v.length === 11 || v.length === 14)) {
            input.classList.add('is-valid'); input.classList.remove('is-invalid');
            feedback.innerHTML = '<span class="text-success"><i class="bi bi-check"></i> Formato OK</span>';
        } else if(v.length > 0) {
            input.classList.add('is-invalid'); input.classList.remove('is-valid');
            feedback.innerHTML = '<span class="text-danger">Dígitos incorretos.</span>';
        } else {
            input.classList.remove('is-valid', 'is-invalid'); feedback.innerHTML = '';
        }
    }
    
    function resetDocField() {
        const i = document.getElementById('cpf_cnpj');
        i.value = ''; i.classList.remove('is-valid', 'is-invalid');
        document.getElementById('docFeedback').innerHTML = '';
        i.focus();
    }
    
    // CEP
    function consultaCEP() {
        const cep = document.getElementById('cep').value.replace(/\D/g, "");
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(r => r.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('logradouro').value = data.logradouro;
                        document.getElementById('bairro').value = data.bairro;
                        document.getElementById('cidade').value = data.localidade;
                        document.getElementById('estado').value = data.uf;
                        document.getElementById('numero').focus();
                    }
                });
        }
    }

    // INICIALIZAÇÃO
    document.addEventListener('DOMContentLoaded', function() {
        const radios = document.querySelectorAll('input[name="tipo_cliente"]');
        const divCiclo = document.getElementById('regraCicloDiv');
        
        function toggle() {
            divCiclo.style.display = document.getElementById('tipoMensalista').checked ? 'block' : 'none';
        }
        radios.forEach(r => r.addEventListener('change', toggle));
        toggle();
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Veículos Estacionados{% endblock %}

{% block content %}



<div class="card mb-4 border-primary shadow-sm">

<div class="card-body bg-light">

<form action="{{ url_for('buscar_saida') }}" method="POST" class="row g-2 align-items-center">

<div class="col-auto">

<i class="bi bi-qr-code-scan fs-3 text-primary"></i>

</div>

<div class="col">

<input type="text" name="termo" class="form-control form-control-lg" placeholder="Escaneie o QR Code ou digite a Placa/Ticket aqui..." autofocus autocomplete="off">

</div>

<div class="col-auto">

<button type="submit" class="btn btn-lg btn-primary">

<i class="bi bi-search"></i> Buscar

</button>

</div>

</form>

</div>

</div>



<div class="d-flex justify-content-between align-items-center mb-3">

<h4 class="mb-0"><i class="bi bi-p-square-fill me-2"></i> Veículos no Pátio ({{ tickets | length }})</h4>

</div>



<div id="tarifas-data"

data-carro="{{ tarifas.valor_carro }}"

data-moto="{{ tarifas.valor_moto }}"

data-tol="{{ tarifas.tolerancia_minutos }}"

data-teto="{{ tarifas.teto_diaria }}"

style="display: none;"></div>



<div class="card shadow-sm">

<div class="card-body p-0">

<div class="table-responsive">

<table class="table table-hover table-striped mb-0 align-middle">

<thead class="table-light">

<tr>

<th class="text-center">Ticket</th>

<th class="text-center">Placa</th>

<th class="text-center">Tipo</th>

<th class="text-center">Entrada</th>

<th class="text-center">Tempo Decorrido</th>

<th class="text-end">Valor Atual</th>

<th class="text-center">Ações</th>

</tr>

</thead>

<tbody>

{% for t in tickets %}

<tr id="row-{{ t.id }}" class="{% if t.is_mensalista_ativo %}table-success{% endif %}">

<td class="text-center">

<span class="badge bg-light text-dark border border-secondary">

{{ t.ticket_numero }}

</span>

</td>


<td class="fs-5 fw-bold text-center">

{{ t.placa }}

{% if t.local %}

<br><span class="badge bg-info text-dark" style="font-size: 0.7rem;"><i class="bi bi-geo-alt-fill"></i> {{ t.local }}</span>

{% endif %}

</td>


<td class="text-center">

{% if t.tipo == 'CARRO' %}<i class="bi bi-car-front-fill text-primary"></i>

{% elif t.tipo == 'MOTO' %}<i class="bi bi-bicycle text-success"></i>

{% else %}<i class="bi bi-person-badge-fill text-info"></i>{% endif %}

</td>


<td class="text-center">{{ t.entrada }}</td>


<td class="fw-bold text-primary text-center">

<i class="bi bi-clock-history me-1"></i>

<span class="live-timer"

data-entry="{{ t.entrada }}"

data-type="{{ t.tipo }}"

data-id="{{ t.id }}"

data-mensalista="{{ '1' if t.is_mensalista_ativo else '0' }}">

Calculando...

</span>

</td>


<td class="fs-5 text-end">

<span id="price-{{ t.id }}" class="fw-bold text-success">

{% if t.valor_a_pagar == 0 or t.is_mensalista_ativo %}

<span class="badge bg-success">ISENTO</span>

{% else %}

R$ {{ '%.2f' | format(t.valor_a_pagar) }}

{% endif %}

</span>

</td>


<td class="text-center">

<div class="d-flex justify-content-center align-items-center gap-2">


<a href="{{ url_for('imprimir_entrada', id=t.id) }}" target="_blank" class="btn btn-sm btn-outline-dark" title="Reimprimir Ticket de Entrada">

<i class="bi bi-printer"></i>

</a>



{% if t.is_mensalista_ativo %}

<form action="{{ url_for('finalizar_pagamento', id=t.id) }}" method="POST" class="d-inline-flex align-items-center">

<button type="submit" class="btn btn-sm btn-success" style="min-width: 100px;" onclick="return confirm('Confirmar saída do mensalista?')">

<i class="bi bi-box-arrow-right me-1"></i> Saída

</button>

</form>

{% else %}

<a href="{{ url_for('visualizar_pagamento', id=t.id) }}" id="btn-{{ t.id }}" class="btn btn-sm {{ 'btn-outline-success' if t.valor_a_pagar == 0 else 'btn-primary' }}" style="min-width: 100px;">

{% if t.valor_a_pagar == 0 %}

<i class="bi bi-check-lg me-1"></i> Liberar

{% else %}

<i class="bi bi-cash-coin me-1"></i> Receber

{% endif %}

</a>

{% endif %}

</div>

</td>

</tr>

{% else %}

<tr>

<td colspan="7" class="text-center py-5 text-muted">

<i class="bi bi-check-circle fs-1 d-block mb-3"></i>

Nenhum veículo estacionado no momento.

</td>

</tr>

{% endfor %}

</tbody>

</table>

</div>

</div>

</div>



<div class="mt-3">

<div class="row text-center text-muted small">

<div class="col">

<i class="bi bi-info-circle"></i> Tolerância: {{ tarifas.tolerancia_minutos }} min

</div>

<div class="col">

Carro: R$ {{ '%.2f'|format(tarifas.valor_carro) }}/h

</div>

<div class="col">

Moto: R$ {{ '%.2f'|format(tarifas.valor_moto) }}/h

</div>

</div>

</div>



<script>

// Código JavaScript de cálculo de tempo em tempo real (mantido inalterado)

const configDiv = document.getElementById('tarifas-data');

if (configDiv) {

const VALOR_CARRO = parseFloat(configDiv.dataset.carro);

const VALOR_MOTO = parseFloat(configDiv.dataset.moto);

const TOLERANCIA_MIN = parseInt(configDiv.dataset.tol);

const TETO_DIARIA = parseFloat(configDiv.dataset.teto);



function parseDatePTBR(dateString) {

if (!dateString) return new Date();

var parts = dateString.split(' ');

var dateParts = parts[0].split('/');

var timeParts = parts[1].split(':');

return new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1], timeParts[2]);

}



function updateDashboard() {

const timers = document.querySelectorAll('.live-timer');

const now = new Date();



timers.forEach(timer => {

const entryDate = parseDatePTBR(timer.dataset.entry);

const veiculoTipo = timer.dataset.type; // CARRO ou MOTO

const isMensalista = timer.dataset.mensalista === '1';

const ticketId = timer.dataset.id;



// Elementos visuais para atualizar

const priceSpan = document.getElementById(`price-${ticketId}`);

const btnAction = document.getElementById(`btn-${ticketId}`);



// Diferença em segundos

let diffSeconds = Math.floor((now - entryDate) / 1000);

if (diffSeconds < 0) diffSeconds = 0;



// 1. Atualiza o Tempo (00h 00m)

const hours = Math.floor(diffSeconds / 3600);

const minutes = Math.floor((diffSeconds % 3600) / 60);

const minStr = minutes < 10 ? '0' + minutes : minutes;

timer.textContent = `${hours}h ${minStr}m`;



// 2. Calcula o Preço

let valor = 0.0;

let isIsento = false;



if (isMensalista) {

isIsento = true; // Mensalista sempre 0

} else {

// Lógica de Tolerância

if (diffSeconds <= (TOLERANCIA_MIN * 60)) {

isIsento = true;

valor = 0.0;

} else {

// Lógica de Cobrança

let horasCobrar = Math.ceil(diffSeconds / 3600); // Arredonda hora pra cima

if (horasCobrar === 0) horasCobrar = 1; // Mínimo 1h se passou da tolerância



let tarifaHora = (veiculoTipo === 'MOTO') ? VALOR_MOTO : VALOR_CARRO;


if (horasCobrar <= 24) {

valor = horasCobrar * tarifaHora;

if (valor > TETO_DIARIA) valor = TETO_DIARIA;

} else {

let dias = Math.ceil(horasCobrar / 24);

valor = dias * TETO_DIARIA;

}

}

}



// 3. Atualiza o Visual do Preço e do Botão

if (priceSpan) {

if (isIsento) {

priceSpan.innerHTML = '<span class="badge bg-success">ISENTO</span>';


// Atualiza botão para verde (Liberar)

if (btnAction && !isMensalista) {

btnAction.className = 'btn btn-sm btn-outline-success';

btnAction.innerHTML = '<i class="bi bi-check-lg me-1"></i> Liberar';

}

} else {

priceSpan.innerHTML = `R$ ${valor.toFixed(2).replace('.', ',')}`;


// Atualiza botão para azul/padrão (Receber)

if (btnAction && !isMensalista) {

btnAction.className = 'btn btn-sm btn-primary';

btnAction.innerHTML = '<i class="bi bi-cash-coin me-1"></i> Receber';

}

}

}

});

}



document.addEventListener('DOMContentLoaded', () => {

updateDashboard();

setInterval(updateDashboard, 1000); // Atualiza a cada segundo

});

}

</script>

{% endblock %}
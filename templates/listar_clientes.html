{% extends "base.html" %}
{% import '_macros.html' as macros %}

{% block title %}Clientes Cadastrados{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary"><i class="bi bi-people-fill me-2"></i> Clientes Cadastrados</h1>
    <a href="{{ url_for('novo_cliente') }}" class="btn btn-primary"><i class="bi bi-person-plus-fill me-1"></i> Novo Cliente</a>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-8">
                <input type="text" id="buscaCliente" class="form-control" placeholder="Buscar por Nome, Placa, ou CPF/CNPJ..." onkeyup="filtrarTabela('buscaCliente', null, null, 'tabelaClientes')">
            </div>
            <div class="col-md-4">
                <select id="filtroTipo" class="form-select" onchange="filtrarTabela('buscaCliente', null, null, 'tabelaClientes', 'filtroTipo')">
                    <option value="">Todos os Clientes</option>
                    <option value="MENSALISTA">Mensalistas</option>
                    <option value="AVULSO">Avulsos</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0 align-middle" id="tabelaClientes">
                <thead class="table-light">
                    <tr>
                        <th class="text-center" style="width: 5%;">#</th>
                        <th style="width: 30%;">Cliente / Status</th>
                        <th class="text-center" style="width: 30%;">Veículos</th>
                        <th style="width: 25%;">Contato</th>
                        <th class="text-center" style="width: 10%;">Ações</th> 
                    </tr>
                </thead>
                <tbody>
                    {% for c in clientes %}
                    <tr data-tipo="{{ c.tipo_cliente }}">
                        <td class="text-center text-muted">{{ loop.index }}</td>
                        
                        <td>
                            <strong title="{{ c.nome }}" class="text-dark fs-6">
                                {{ c.nome | truncate(30, true, '...') }}
                            </strong>
                            <div class="mt-1">
                                {% if c.tipo_cliente == 'MENSALISTA' %}
                                    <span class="badge bg-primary rounded-pill status-badge" style="font-size: 0.75em;">
                                        <i class="bi bi-calendar-check-fill me-1"></i>Mensalista
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary rounded-pill status-badge" style="font-size: 0.75em;">
                                        <i class="bi bi-hourglass-split me-1"></i>Avulso
                                    </span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td class="text-center">
                            
                            {% if c.veiculos and c.veiculos|length > 0 %}
                                {% for v in c.veiculos %}
                                    <div class="{{ 'mb-2 pb-2 border-bottom' if not loop.last else '' }}">
                                        <span class="badge bg-light text-dark border fw-bold mb-1" style="font-size: 0.9em; letter-spacing: 1px;">
                                            {{ v.placa | fmt_placa }}
                                        </span>
                                        <div class="small text-muted">
                                            {% if v.tipo == 'MOTO' %}
                                                <i class="bi bi-bicycle me-1 text-primary" title="Moto"></i>
                                            {% else %}
                                                <i class="bi bi-car-front-fill me-1 text-primary" title="Carro"></i>
                                            {% endif %}
                                            
                                            {% set detalhes = [v.marca, v.modelo, v.cor] | select('defined') | select('ne', None) | select('ne', '') | join(' - ') %}
                                            {{ detalhes or '---' }}
                                        </div>
                                    </div>
                                {% endfor %}

                            {% else %}
                                <span class="badge bg-light text-dark border fw-bold mb-1" style="font-size: 0.9em; letter-spacing: 1px;">
                                    {{ c.placa | fmt_placa }}
                                </span>
                                <div class="small text-muted">
                                    {% if c.tipo_veiculo == 'MOTO' %}
                                        <i class="bi bi-bicycle me-1 text-primary" title="Moto"></i>
                                    {% else %}
                                        <i class="bi bi-car-front-fill me-1 text-primary" title="Carro"></i>
                                    {% endif %}
                                    {% set veiculo = [c.marca_veiculo, c.modelo_veiculo, c.cor_veiculo] | select('defined') | select('ne', None) | select('ne', '') | join(' - ') %}
                                    {{ veiculo or '---' }}
                                </div>
                            {% endif %}
                        </td>
                        
                        <td>
                            <div class="d-flex flex-column">
                                <span class="mb-1">
                                    <i class="bi bi-phone me-2 text-muted"></i>{{ c.telefone }}
                                    {% if c.is_whatsapp %}
                                        <i class="bi bi-whatsapp text-success ms-1" title="WhatsApp"></i>
                                    {% endif %}
                                </span>
                                {% if c.email %}
                                    <small class="text-muted text-truncate" style="max-width: 200px;">
                                        <i class="bi bi-envelope me-2"></i>{{ c.email }}
                                    </small>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td class="text-center"> 
                            {{ macros.botao_acao_tabela(
                                editar_url=url_for('editar_cliente', id=c.id),
                                excluir_url=url_for('excluir_cliente', id=c.id),
                                is_recorrente=false
                            ) }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="bi bi-person-x fs-1 d-block mb-3"></i>
                            Nenhum cliente encontrado.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmacao" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white" id="modalHeaderColor"><h5 class="modal-title" id="modalTitulo">Confirmação</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p id="modalMensagem">Tem certeza?</p></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><a href="#" id="modalBtnConfirmar" class="btn btn-primary">Confirmar</a></div></div></div></div>

<script>
    function filtrarTabela(inputId, dateIniId, dateFimId, tabelaId, selectFilterId=null) {
        const input = document.getElementById(inputId);
        const tabela = document.getElementById(tabelaId);
        const linhas = tabela.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        const select = selectFilterId ? document.getElementById(selectFilterId) : null;
        
        function filtrar() {
            const termo = input.value.toLowerCase();
            const valorFiltro = select ? select.value : '';
            const isFilterAtivo = select && select.value !== "";

            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i];
                const texto = linha.innerText.toLowerCase();
                const tipoCliente = linha.getAttribute('data-tipo');
                
                const matchTexto = termo === "" || texto.includes(termo);
                let matchFiltro = true;

                if (isFilterAtivo && select.id === 'filtroTipo') {
                    matchFiltro = tipoCliente === valorFiltro;
                }

                linha.style.display = (matchTexto && matchFiltro) ? "" : "none";
            }
        }

        input.addEventListener('keyup', filtrar);
        if (select) select.addEventListener('change', filtrar);
        
        filtrar();
    }

    function confirmarAcao(acao, url, isDelete = false) {
        const modal = new bootstrap.Modal(document.getElementById('modalConfirmacao'));
        document.getElementById('modalTitulo').innerText = acao;
        document.getElementById('modalMensagem').innerText = `Confirmar ${acao} de cliente?`;
        document.getElementById('modalBtnConfirmar').href = url;
        
        const header = document.getElementById('modalHeaderColor');
        const btn = document.getElementById('modalBtnConfirmar');
        
        if (isDelete) {
            header.className = 'modal-header bg-danger text-white';
            btn.className = 'btn btn-danger';
            btn.innerText = 'Excluir';
        } else {
            header.className = 'modal-header bg-primary text-white';
            btn.className = 'btn btn-primary';
            btn.innerText = 'Confirmar';
        }
        modal.show();
    }
</script>
{% endblock %}
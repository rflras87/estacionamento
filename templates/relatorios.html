{% extends "base.html" %}

{% block title %}Relatório de Vendas{% endblock %}

{% block content %}
<style>
    /* --- SEU CSS ORIGINAL (Tabelas e Expansão) --- */
    .collapse.show td {
        background-color: white !important;
        padding-top: 8px; 
        padding-bottom: 8px;
        border-top: none !important; 
        border-bottom: 1px solid #dee2e6; 
    }
    .collapse.show td:first-child { border-left: 3px solid #0d6efd !important; }
    .collapse.show td:last-child { border-right: 3px solid #0d6efd !important; }
    .tr-last-of-group td { border-bottom: 3px solid #0d6efd !important; }
    .col-md-1 input[type="text"] { max-width: 70px; }
    .collapse.multi-{{ outer_index }}:focus { outline: none !important; box-shadow: none !important; }
    .table-secondary { border-top: 1px solid #dee2e6 !important; }
    .tr-detail { border-top: none !important; }

    /* --- NOVO CSS (Cards e Estilos Visuais) --- */
    
    /* Cabeçalho de Filtros Escuro */
    .filter-header-dark {
        background-color: #1f2937; /* Cinza escuro/Preto */
        color: #ffffff;
        border-bottom: none;
    }

    /* Estilo Base dos Cards */
    .stat-card {
        position: relative;
        border-radius: 8px;
        padding: 20px;
        color: #fff;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-3px); }

    /* Tipografia do Card */
    .stat-card .card-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        font-weight: 700;
        opacity: 0.9;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        z-index: 2;
    }
    .stat-card .card-value {
        font-size: 1.6rem;
        font-weight: 800;
        z-index: 2;
    }

    /* Ícone de Fundo Translúcido */
    .stat-card .bg-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 3.5rem;
        opacity: 0.25;
        z-index: 1;
    }

    /* Gradientes */
    .bg-gradient-blue { background: linear-gradient(45deg, #2563eb, #3b82f6); }
    .bg-gradient-green { background: linear-gradient(45deg, #15803d, #22c55e); }
    .bg-gradient-cyan { background: linear-gradient(45deg, #0891b2, #06b6d4); }
    .bg-gradient-yellow { background: linear-gradient(45deg, #ca8a04, #eab308); color: #fff; }

</style>

<div class="d-flex align-items-center mb-4 mt-3">
    <i class="bi bi-check2-circle text-dark me-3" style="font-size: 3rem;"></i>
    <div>
        <h2 class="fw-bold mb-0">Relatório de Tickets Pagos</h2>
        <small class="text-muted">Visão detalhada de transações financeiras</small>
    </div>
</div>

<div class="card shadow mb-4 border-0">
    <div class="card-header filter-header-dark py-3">
        <h5 class="mb-0 d-flex align-items-center">
            <i class="bi bi-funnel-fill me-2"></i> Filtros & Pesquisa
        </h5>
    </div>
    <div class="card-body bg-light">
        <form method="POST" action="{{ url_for('relatorios') }}">
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label fw-bold small text-muted">Pesquisar (Placa, Nome ou Ticket)</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0" name="termo" value="{{ filtro_termo }}" placeholder="Digite Placa, Nome ou Número do Ticket...">
                    </div>
                </div>
            </div>

            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small text-muted fw-bold">Data Início</label>
                    <input type="date" class="form-control" name="data_inicio" value="{{ filtro_inicio_date or '' }}">
                </div>
                <div class="col-md-1" style="max-width: 95px;">
                    <label class="form-label small text-muted fw-bold">Hora</label>
                    <input type="text" class="form-control" name="hora_inicio" value="{{ filtro_hora_inicio or '' }}" placeholder="00:00" style="width: 100%;" maxlength="5">
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted fw-bold">Data Fim</label>
                    <input type="date" class="form-control" name="data_fim" value="{{ filtro_fim_date or '' }}">
                </div>
                <div class="col-md-1" style="max-width: 95px;">
                    <label class="form-label small text-muted fw-bold">Hora</label>
                    <input type="text" class="form-control" name="hora_fim" value="{{ filtro_hora_fim or '' }}" placeholder="23:59" style="width: 100%;" maxlength="5">
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted fw-bold">Tipo de Cliente</label>
                    <select class="form-select" name="tipo_cliente">
                        <option value="TODOS" {% if filtro_tipo == 'TODOS' %}selected{% endif %}>Todos</option>
                        <option value="AVULSO" {% if filtro_tipo == 'AVULSO' %}selected{% endif %}>Avulsos</option>
                        <option value="MENSALISTA" {% if filtro_tipo == 'MENSALISTA' %}selected{% endif %}>Mensalistas</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted fw-bold">Pagamento</label>
                    <select class="form-select" name="forma_pagamento">
                        <option value="TODOS" {% if filtro_pgto == 'TODOS' %}selected{% endif %}>Todas</option>
                        <option value="Tolerância" {% if filtro_pgto == 'Tolerância' %}selected{% endif %}>Isento / Tolerância</option>
                        {% for f in formas_pagamento %}
                            <option value="{{ f.nome }}" {% if filtro_pgto == f.nome %}selected{% endif %}>{{ f.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-primary w-50"><i class="bi bi-filter me-1"></i> Filtrar</button>
                    <a href="{{ url_for('relatorios') }}" class="btn btn-outline-secondary w-50">Limpar</a>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card bg-gradient-blue">
            <div class="card-label">Total Geral</div>
            <div class="card-value">R$ {{ '%.2f' | format(total_geral) }}</div>
            <i class="bi bi-graph-up-arrow bg-icon"></i>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card bg-gradient-green">
            <div class="card-label">Dinheiro</div>
            <div class="card-value">R$ {{ '%.2f' | format(totais_pgto.get('Dinheiro', 0)) }}</div>
            <i class="bi bi-cash-stack bg-icon"></i>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card bg-gradient-cyan">
            <div class="card-label">Pix</div>
            <div class="card-value">R$ {{ '%.2f' | format(totais_pgto.get('Pix', 0)) }}</div>
            <i class="bi bi-qr-code-scan bg-icon"></i>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card bg-gradient-yellow">
            <div class="card-label">Cartão</div>
            {% set total_cartao = totais_pgto.get('Cartão de Débito', 0) + totais_pgto.get('Cartão de Crédito', 0) + totais_pgto.get('Cartão', 0) %}
            <div class="card-value">R$ {{ '%.2f' | format(total_cartao) }}</div>
            <i class="bi bi-credit-card-2-front bg-icon"></i>
        </div>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-dark text-white"><h5 class="mb-0">Detalhamento</h5></div>
    <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
            <thead class="table-light"><tr><th style="width: 15%;">Ticket / Ref</th><th style="width: 25%;">Veículo / Cliente</th><th style="width: 30%;">Saída / Resumo</th><th style="width: 15%;">Pagamento</th><th style="width: 15%;" class="text-end pe-4">Valor</th></tr></thead>
            <tbody>
                {% for placa, dados in dados_agrupados.items() %}
                    {% set outer_index = loop.index %}
                    {% if dados.tickets | length > 1 %}
                        <tr class="table-secondary border-top"><td class="ps-4"><span class="badge bg-primary"><i class="bi bi-folder-fill me-1"></i> MÚLTIPLOS</span></td><td><strong>{{ dados.placa }}</strong><br><small class="{{ 'text-primary fw-bold' if dados.tipo_cliente == 'MENSALISTA' else 'text-muted' }}">{{ dados.nome_cliente }}</small></td><td><button class="btn btn-sm btn-light border shadow-sm w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target=".multi-{{ outer_index }}" aria-expanded="false" onclick="this.closest('tr').classList.toggle('active-group')"><i class="bi bi-chevron-down me-2"></i> Ver {{ dados.tickets | length }} acessos</button></td><td>{% if dados.tipo_cliente == 'MENSALISTA' %}<span class="badge bg-secondary">Mensalista</span>{% else %}<span class="badge bg-info text-dark">Vários</span>{% endif %}</td><td class="text-end fw-bold pe-4">R$ {{ '%.2f' | format(dados.total_pago_periodo) }}</td></tr>
                        
                        {% for t in dados.tickets %}
                        {% set is_last_row = loop.last %}
                        <tr class="collapse multi-{{ outer_index }} bg-white tr-detail {% if is_last_row %}tr-last-of-group{% endif %}">
                            <td class="ps-4"><span class="font-monospace text-muted small border rounded px-1 bg-light ms-4">{{ t.ticket }}</span></td><td colspan="1"></td>
                            
                            <td class="small py-2">
                                {% if t.valor > 0 and t.status_visual == 'Mensalista' %}
                                    <span class="text-success fw-bold"><i class="bi bi-cash-coin"></i> Renovação Mensalidade</span>
                                {% else %}
                                    <div class="d-flex flex-column">
                                        <span><i class="bi bi-arrow-right-circle-fill text-success me-2"></i> {{ t.entrada }}</span>
                                        <div class="d-flex align-items-center">
                                            <span><i class="bi bi-arrow-left-circle-fill text-danger me-2"></i> {{ t.saida }}</span>
                                            {% if t.divergencia %}
                                                <span class="ms-2 badge bg-warning text-dark" title="Divergência: Tipo cobrado ({{ t.tipo_cobrado }}) difere do cadastro ({{ t.tipo_cadastrado }})">
                                                    <i class="bi bi-exclamation-triangle-fill"></i> Auditoria
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            </td>
                            
                            <td>{% if t.status_visual == 'Tolerância' %}<span class="badge bg-secondary">TOLERÂNCIA</span>{% elif t.valor > 0 and t.status_visual == 'Mensalista' %}{% if t.pgto %}<span class="badge bg-success">PAGO ({{ t.pgto }})</span>{% else %}<span class="badge bg-success">PAGO</span>{% endif %}{% elif 'Dinheiro' in t.pgto %}<span class="badge bg-success"><i class="bi bi-cash-coin me-1"></i> Dinheiro</span>{% elif 'Pix' in t.pgto %}<span class="badge bg-info text-dark"><i class="bi bi-qr-code me-1"></i> Pix</span>{% elif 'Cartão' in t.pgto %}<span class="badge bg-warning text-dark"><i class="bi bi-credit-card me-1"></i> Cartão</span>{% else %}<span class="badge bg-warning text-dark">{{ t.pgto }}</span>{% endif %}</td>
                            <td class="text-end text-muted pe-4">R$ {{ '%.2f' | format(t.valor) }}</td>
                        </tr>
                        {% endfor %}

                    {% else %}
                        {% set t = dados.tickets[0] %}
                        <tr class="border-top">
                            <td class="ps-4"><span class="badge bg-light text-dark border">{{ t.ticket }}</span></td>
                            <td><strong>{{ dados.placa }}</strong><br><small class="{{ 'text-primary fw-bold' if dados.tipo_cliente == 'MENSALISTA' else 'text-muted' }}">{{ dados.nome_cliente }}</small></td>
                            
                            <td class="small py-2">
                                {% if t.valor > 0 and (t.ticket.startswith('MEN') or t.status_visual == 'Mensalista') %}
                                    <span class="text-success fw-bold"><i class="bi bi-cash-coin"></i> Renovação Mensalidade</span><br><small class="text-muted">Pagamento Recebido</small>
                                {% else %}
                                    <div class="d-flex flex-column">
                                        <span><i class="bi bi-arrow-right-circle-fill text-success me-2"></i> {{ t.entrada }}</span>
                                        <div class="d-flex align-items-center">
                                            <span><i class="bi bi-arrow-left-circle-fill text-danger me-2"></i> {{ t.saida }}</span>
                                            {% if t.divergencia %}
                                                <span class="ms-2 badge bg-warning text-dark" title="Divergência: Tipo cobrado ({{ t.tipo_cobrado }}) difere do cadastro ({{ t.tipo_cadastrado }})">
                                                    <i class="bi bi-exclamation-triangle-fill"></i> Auditoria
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            </td>
                            
                            <td>{% if t.status_visual == 'Tolerância' %}<span class="badge bg-secondary">TOLERÂNCIA</span>{% elif 'Dinheiro' in t.pgto %}<span class="badge bg-success"><i class="bi bi-cash-coin me-1"></i> Dinheiro</span>{% elif 'Pix' in t.pgto %}<span class="badge bg-info text-dark"><i class="bi bi-qr-code me-1"></i> Pix</span>{% elif 'Cartão' in t.pgto %}<span class="badge bg-warning text-dark"><i class="bi bi-credit-card me-1"></i> Cartão</span>{% elif t.valor > 0 and (t.ticket.startswith('MEN') or t.status_visual == 'Mensalista') %}{% if t.pgto %}<span class="badge bg-success">PAGO ({{ t.pgto }})</span>{% else %}<span class="badge bg-success">PAGO</span>{% endif %}{% else %}<span class="badge bg-secondary">ISENTO</span>{% endif %}</td>
                            <td class="text-end fw-bold text-success pe-4">R$ {{ '%.2f' | format(t.valor) }}</td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}